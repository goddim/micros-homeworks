
# Домашнее задание к занятию «Микросервисы: принципы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway 

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:
- маршрутизация запросов к нужному сервису на основе конфигурации,
- возможность проверки аутентификационной информации в запросах,
- обеспечение терминации HTTPS.

Обоснуйте свой выбор.

# Ответ

Для реализации API Gateway в микросервисной архитектуре можно рассмотреть несколько популярных решений: NGINX, Kong, Apigee, и AWS API Gateway. Эти решения отличаются по функциональности, производительности и удобству использования. Ниже приведена сравнительная таблица возможностей этих решений с учетом требований:

Функция / Решение	NGINX	Kong	Apigee	AWS API Gateway
Маршрутизация запросов	Да	Да	Да	Да
Аутентификация	Плагинами	Встроено	Встроено	Встроено
Терминация HTTPS	Да	Да	Да	Да
Масштабируемость	Высокая	Высокая	Высокая	Высокая
Поддержка плагинов	Ограничена	Широкая	Ограничена	Нет
Управление API	Ограничено	Да	Да	Да
Легкость интеграции	Средняя	Высокая	Высокая	Высокая
Стоимость	Низкая (open-source)	Средняя (open-source + enterprise)	Высокая	Средняя/Высокая
Поддержка различных протоколов	HTTP/HTTPS	HTTP/HTTPS + TCP/UDP	HTTP/HTTPS	HTTP/HTTPS
Сообщество и поддержка	Широкое	Широкое	Среднее	Широкое
Обоснование выбора
Исходя из требований и сравнительной таблицы, наиболее подходящим решением для реализации API Gateway является Kong. Вот несколько причин для такого выбора:

Маршрутизация запросов:

Kong предлагает гибкие возможности маршрутизации запросов на основе конфигурации.
Аутентификация:

Kong имеет встроенную поддержку различных методов аутентификации и авторизации, таких как JWT, OAuth2, Basic Auth и другие. Это упрощает интеграцию с существующими системами безопасности.
Терминация HTTPS:

Kong обеспечивает терминацию HTTPS, что позволяет безопасно обрабатывать запросы.
Масштабируемость и производительность:

Kong хорошо масштабируется и обеспечивает высокую производительность благодаря своей архитектуре, основанной на NGINX и Lua.
Поддержка плагинов:

Широкий набор доступных плагинов позволяет легко расширять функциональность Kong, что обеспечивает гибкость при изменении требований.
Управление API:

Встроенные возможности управления API позволяют отслеживать и контролировать использование API, что важно для обеспечения стабильности и безопасности системы.
Стоимость:

Kong имеет бесплатную версию с открытым исходным кодом и коммерческую версию с дополнительными возможностями, что делает его доступным для разных бюджетов.
Таким образом, Kong представляет собой мощное и гибкое решение для реализации API Gateway, удовлетворяющее всем указанным требованиям и обладающее широкими возможностями для дальнейшего расширения и настройки.

## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:
- поддержка кластеризации для обеспечения надёжности,
- хранение сообщений на диске в процессе доставки,
- высокая скорость работы,
- поддержка различных форматов сообщений,
- разделение прав доступа к различным потокам сообщений,
- простота эксплуатации.

Обоснуйте свой выбор.

## Задача 3: API Gateway * (необязательная)

### Есть три сервиса:

**minio**
- хранит загруженные файлы в бакете images,
- S3 протокол,

**uploader**
- принимает файл, если картинка сжимает и загружает его в minio,
- POST /v1/upload,

**security**
- регистрация пользователя POST /v1/user,
- получение информации о пользователе GET /v1/user,
- логин пользователя POST /v1/token,
- проверка токена GET /v1/token/validation.

### Необходимо воспользоваться любым балансировщиком и сделать API Gateway:

**POST /v1/register**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/user.

**POST /v1/token**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/token.

**GET /v1/user**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис security GET /v1/user.

**POST /v1/upload**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис uploader POST /v1/upload.

**GET /v1/user/{image}**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис minio GET /images/{image}.

### Ожидаемый результат

Результатом выполнения задачи должен быть docker compose файл, запустив который можно локально выполнить следующие команды с успешным результатом.
Предполагается, что для реализации API Gateway будет написан конфиг для NGinx или другого балансировщика нагрузки, который будет запущен как сервис через docker-compose и будет обеспечивать балансировку и проверку аутентификации входящих запросов.
Авторизация
curl -X POST -H 'Content-Type: application/json' -d '{"login":"bob", "password":"qwe123"}' http://localhost/token

**Загрузка файла**

curl -X POST -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJib2IifQ.hiMVLmssoTsy1MqbmIoviDeFPvo-nCd92d4UFiN2O2I' -H 'Content-Type: octet/stream' --data-binary @yourfilename.jpg http://localhost/upload

**Получение файла**
curl -X GET http://localhost/images/4e6df220-295e-4231-82bc-45e4b1484430.jpg

---

#### [Дополнительные материалы: как запускать, как тестировать, как проверить](https://github.com/netology-code/devkub-homeworks/tree/main/11-microservices-02-principles)

---

### Как оформить ДЗ?

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---
